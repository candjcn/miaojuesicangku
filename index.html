<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>寺庙仓库管理系统</title>
    <style>
        :root { --primary: #4CAF50; --warning: #ff9800; --danger: #f44336; }
        * { box-sizing: border-box; font-family: Arial, sans-serif; }
        body { margin: 0; padding: 10px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .tabs { display: flex; margin-bottom: 10px; }
        .tab { flex:1; padding:10px; text-align:center; background:#ddd; border:none; cursor:pointer; }
        .tab.active { background:var(--primary); color:white; }
        .card { background:white; padding:15px; margin-bottom:10px; border-radius:5px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
        .form-group { margin-bottom:10px; }
        input, select, button { width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; }
        button { background:var(--primary); color:white; border:none; margin:2px; }
        button.warning { background:var(--warning); }
        button.danger { background:var(--danger); }
        .table { width:100%; border-collapse:collapse; }
        .table td, .table th { padding:8px; border-bottom:1px solid #ddd; text-align:left; }
        .alert { background:#ffeb3b; padding:10px; margin:10px 0; border-radius:4px; }
        @media (min-width: 600px) { .cols { display:flex; gap:10px; } .cols > * { flex:1; } }
    </style>
</head>
<body>
<div class="container">
    <div class="tabs">
        <button class="tab active" onclick="showTab('dashboard')">📊 仪表盘</button>
        <button class="tab" onclick="showTab('items')">📦 物品</button>
        <button class="tab" onclick="showTab('in')">⬇️ 入库</button>
        <button class="tab" onclick="showTab('out')">⬆️ 出库</button>
        <button class="tab" onclick="showTab('reports')">📈 报表</button>
    </div>

    <!-- 仪表盘 -->
    <div id="dashboard" class="tab-content">
        <div class="cols">
            <div class="card">
                <h3>仓库概览</h3>
                <p>总物品数: <span id="totalItems">0</span></p>
                <p>库存总量: <span id="totalStock">0</span></p>
                <p>预警物品: <span id="warningItems">0</span></p>
            </div>
            <div class="card">
                <h3>库存预警</h3>
                <div id="alertsList"></div>
            </div>
        </div>
        <div class="card">
            <h3>最近活动</h3>
            <div id="recentActivities"></div>
        </div>
    </div>

    <!-- 物品管理 -->
    <div id="items" class="tab-content" style="display:none">
        <div class="card">
            <h3>物品管理</h3>
            <form id="itemForm" onsubmit="return saveItem(event)">
                <input type="hidden" id="itemId">
                <div class="form-group"><input type="text" id="itemName" placeholder="物品名称" required></div>
                <div class="cols">
                    <div class="form-group">
                        <select id="itemCategory" required>
                            <option value="">分类</option>
                            <option value="佛具">佛具</option>
                            <option value="法物">法物</option>
                            <option value="日用品">日用品</option>
                        </select>
                    </div>
                    <div class="form-group"><input type="text" id="itemSpec" placeholder="规格"></div>
                    <div class="form-group"><input type="text" id="itemUnit" placeholder="单位" required></div>
                </div>
                <div class="form-group"><input type="number" id="itemMinStock" placeholder="最低库存" required></div>
                <button type="submit">💾 保存</button>
            </form>
        </div>
        <div class="card">
            <h3>物品列表 <button onclick="exportData()" class="warning">📤 导出数据</button></h3>
            <div id="itemList"></div>
        </div>
    </div>

    <!-- 入库管理 -->
    <div id="in" class="tab-content" style="display:none">
        <div class="card">
            <h3>物品入库</h3>
            <form onsubmit="return stockIn(event)">
                <div class="form-group">
                    <select id="inItem" required>
                        <option value="">选择物品</option>
                        ${loadItemOptions()}
                    </select>
                </div>
                <div class="cols">
                    <div class="form-group"><input type="number" id="inQty" placeholder="数量" required></div>
                    <div class="form-group"><input type="text" id="inOperator" placeholder="操作人" required></div>
                </div>
                <div class="form-group"><input type="date" id="inDate" required></div>
                <button type="submit">✅ 确认入库</button>
            </form>
        </div>
        <div class="card">
            <h3>入库记录</h3>
            <div id="inRecords"></div>
        </div>
    </div>

    <!-- 出库管理 -->
    <div id="out" class="tab-content" style="display:none">
        <div class="card">
            <h3>物品出库</h3>
            <form onsubmit="return stockOut(event)">
                <div class="form-group">
                    <select id="outItem" required>
                        <option value="">选择物品</option>
                        ${loadItemOptions()}
                    </select>
                </div>
                <div class="cols">
                    <div class="form-group"><input type="number" id="outQty" placeholder="数量" required></div>
                    <div class="form-group"><input type="text" id="outOperator" placeholder="操作人" required></div>
                </div>
                <div class="form-group"><input type="date" id="outDate" required></div>
                <button type="submit">✅ 确认出库</button>
            </form>
        </div>
        <div class="card">
            <h3>出库记录</h3>
            <div id="outRecords"></div>
        </div>
    </div>

    <!-- 统计报表 -->
    <div id="reports" class="tab-content" style="display:none">
        <div class="card">
            <h3>库存统计 <select id="reportType" onchange="generateReport()">
                <option value="month">月度报表</option>
                <option value="year">年度报表</option>
            </select></h3>
            <div id="reportResult"></div>
        </div>
        <div class="card">
            <h3>数据管理</h3>
            <button onclick="exportData()" class="warning">📤 导出数据</button>
            <button onclick="importData()" class="primary">📥 导入数据</button>
            <input type="file" id="fileInput" style="display:none">
        </div>
    </div>
</div>

<script>
// 数据存储
let db = {
    items: JSON.parse(localStorage.getItem('items') || '[]'),
    inRecords: JSON.parse(localStorage.getItem('inRecords') || '[]'),
    outRecords: JSON.parse(localStorage.getItem('outRecords') || '[]')
};

// 通用功能
function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).style.display = 'block';
    event.target.classList.add('active');
    if(tabId === 'dashboard') updateDashboard();
}

// 物品管理
function saveItem(e) {
    e.preventDefault();
    const item = {
        id: document.getElementById('itemId').value || Date.now().toString(),
        name: document.getElementById('itemName').value,
        category: document.getElementById('itemCategory').value,
        spec: document.getElementById('itemSpec').value,
        unit: document.getElementById('itemUnit').value,
        minStock: parseInt(document.getElementById('itemMinStock').value)
    };
    const index = db.items.findIndex(i => i.id === item.id);
    if (index > -1) db.items[index] = item;
    else db.items.push(item);
    saveData();
    document.getElementById('itemForm').reset();
    renderItems();
}

function renderItems() {
    let html = '<table class="table">';
    db.items.forEach(item => {
        const stock = getStock(item.id);
        html += `<tr ${stock < item.minStock ? 'style="background:#ffe082"' : ''}>
            <td>${item.name} (${item.category})</td>
            <td>${stock}${item.unit}</td>
            <td><button onclick="editItem('${item.id}')">✏️</button>
            <button class="danger" onclick="deleteItem('${item.id}')">🗑️</button></td>
        </tr>`;
    });
    document.getElementById('itemList').innerHTML = html + '</table>';
    updateDashboard();
}

function editItem(id) {
    const item = db.items.find(i => i.id === id);
    if(item) {
        document.getElementById('itemId').value = item.id;
        document.getElementById('itemName').value = item.name;
        document.getElementById('itemCategory').value = item.category;
        document.getElementById('itemSpec').value = item.spec;
        document.getElementById('itemUnit').value = item.unit;
        document.getElementById('itemMinStock').value = item.minStock;
    }
}

function deleteItem(id) {
    if(confirm('确定删除？')) {
        db.items = db.items.filter(i => i.id !== id);
        saveData();
        renderItems();
    }
}

// 入库出库功能
function stockIn(e) {
    e.preventDefault();
    const record = {
        id: Date.now(),
        itemId: document.getElementById('inItem').value,
        qty: parseInt(document.getElementById('inQty').value),
        operator: document.getElementById('inOperator').value,
        date: document.getElementById('inDate').value || new Date().toISOString().slice(0,10)
    };
    db.inRecords.push(record);
    saveData();
    updateDashboard();
    e.target.reset();
}

function stockOut(e) {
    e.preventDefault();
    const itemId = document.getElementById('outItem').value;
    const qty = parseInt(document.getElementById('outQty').value);
    if(getStock(itemId) < qty) return alert('库存不足！');
    
    const record = {
        id: Date.now(),
        itemId: itemId,
        qty: qty,
        operator: document.getElementById('outOperator').value,
        date: document.getElementById('outDate').value || new Date().toISOString().slice(0,10)
    };
    db.outRecords.push(record);
    saveData();
    updateDashboard();
    e.target.reset();
}

// 数据统计
function getStock(itemId) {
    const inQty = db.inRecords.filter(r => r.itemId === itemId).reduce((a,b) => a + b.qty, 0);
    const outQty = db.outRecords.filter(r => r.itemId === itemId).reduce((a,b) => a + b.qty, 0);
    return inQty - outQty;
}

function updateDashboard() {
    document.getElementById('totalItems').textContent = db.items.length;
    document.getElementById('totalStock').textContent = db.items.reduce((a,b) => a + getStock(b.id), 0);
    const warnings = db.items.filter(item => getStock(item.id) < item.minStock);
    document.getElementById('warningItems').textContent = warnings.length;
    
    let alertsHtml = warnings.map(item => 
        `${item.name} 库存 ${getStock(item.id)}${item.unit} (最低 ${item.minStock})`).join('
');
    document.getElementById('alertsList').innerHTML = alertsHtml || '无预警物品';
    
    // 最近活动
    const activities = [...db.inRecords, ...db.outRecords]
        .sort((a,b) => b.id - a.id)
        .slice(0,10)
        .map(r => {
            const item = db.items.find(i => i.id === r.itemId);
            return `${r.date} ${r.qty}${item?.unit} ${item?.name} (${'qty' in r ? '出库' : '入库'})`;
        });
    document.getElementById('recentActivities').innerHTML = activities.join('
') || '暂无活动';
}

// 数据持久化
function saveData() {
    localStorage.setItem('items', JSON.stringify(db.items));
    localStorage.setItem('inRecords', JSON.stringify(db.inRecords));
    localStorage.setItem('outRecords', JSON.stringify(db.outRecords));
}

// 初始化
function init() {
    document.getElementById('inDate').value = new Date().toISOString().slice(0,10);
    document.getElementById('outDate').value = new Date().toISOString().slice(0,10);
    renderItems();
    updateDashboard();
}
init();
</script>
</body>
</html>
