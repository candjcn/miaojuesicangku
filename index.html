<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <title>æ™ºæ…§å¯ºé™¢ä»“åº“ç®¡ç†ç³»ç»Ÿ</title>
  <style>
    :root {
      --primary: #3498db;
      --danger: #e74c3c;
      --success: #2ecc71;
      --text: #2c3e50;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f6fa;
      margin: 0;
      padding: 15px;
      color: var(--text);
      line-height: 1.6;
    }

    h1 {
      text-align: center;
      font-size: 1.8rem;
      margin: 20px 0;
      color: var(--text);
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 3px 15px rgba(0,0,0,0.1);
    }

    input, select, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.2s;
    }

    input:focus, select:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 2px rgba(52,152,219,0.2);
    }

    button {
      background: var(--primary);
      color: white;
      border: none;
      font-weight: 500;
      cursor: pointer;
    }

    button.danger {
      background: var(--danger);
    }

    button.success {
      background: var(--success);
    }

    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      min-width: 600px;
      border-collapse: collapse;
      margin: 15px 0;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #f8f9fa;
      font-weight: 600;
    }

    .warning {
      color: var(--danger);
      font-weight: 500;
    }

    @media (min-width: 768px) {
      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }
    }

    .mb-0 { margin-bottom: 0 !important; }
    .mt-20 { margin-top: 20px; }
    .text-center { text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <h1>æ™ºæ…§å¯ºé™¢ä»“åº“ç®¡ç†ç³»ç»Ÿ</h1>

    <!-- ç‰©å“ç®¡ç† -->
    <div class="card">
      <h2>ğŸ“¦ ç‰©å“ç®¡ç†</h2>
      <div class="form-grid">
        <input type="text" id="itemName" placeholder="ç‰©å“åç§°" required>
        <input type="text" id="itemCategory" placeholder="åˆ†ç±»">
        <input type="text" id="itemSpec" placeholder="è§„æ ¼">
        <input type="text" id="itemUnit" placeholder="å•ä½">
        <input type="number" id="itemQuantity" placeholder="åˆå§‹æ•°é‡" min="0">
        <input type="number" id="itemMin" placeholder="æœ€ä½åº“å­˜" min="0">
      </div>
      <button onclick="addItem()" class="success">â• æ·»åŠ ç‰©å“</button>
      
      <div class="table-container mt-20">
        <table id="itemsTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>åç§°</th>
              <th>åˆ†ç±»</th>
              <th>è§„æ ¼</th>
              <th>å•ä½</th>
              <th>åº“å­˜</th>
              <th>é¢„è­¦å€¼</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- å…¥åº“ç®¡ç† -->
    <div class="card">
      <h2>â¬‡ï¸ å…¥åº“ç®¡ç†</h2>
      <div class="form-grid">
        <select id="inboundItem"></select>
        <input type="number" id="inboundQty" placeholder="æ•°é‡" min="0.01" step="0.01">
        <input type="text" id="inboundSource" placeholder="æ¥æº">
        <input type="date" id="inboundDate" required>
        <input type="text" id="inboundOperator" placeholder="ç»æ‰‹äºº">
      </div>
      <button onclick="addInbound()">ğŸ“¥ æäº¤å…¥åº“</button>
      
      <div class="table-container mt-20">
        <table id="inboundTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>ç‰©å“</th>
              <th>æ•°é‡</th>
              <th>æ¥æº</th>
              <th>æ—¥æœŸ</th>
              <th>ç»æ‰‹äºº</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- å‡ºåº“ç®¡ç† -->
    <div class="card">
      <h2>â¬†ï¸ å‡ºåº“ç®¡ç†</h2>
      <div class="form-grid">
        <select id="outboundItem"></select>
        <input type="number" id="outboundQty" placeholder="æ•°é‡" min="0.01" step="0.01">
        <input type="text" id="outboundPurpose" placeholder="ç”¨é€”">
        <input type="text" id="outboundReceiver" placeholder="é¢†ç”¨äºº">
        <input type="date" id="outboundDate" required>
      </div>
      <button onclick="addOutbound()">ğŸ“¤ æäº¤å‡ºåº“</button>
      
      <div class="table-container mt-20">
        <table id="outboundTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>ç‰©å“</th>
              <th>æ•°é‡</th>
              <th>ç”¨é€”</th>
              <th>é¢†ç”¨äºº</th>
              <th>æ—¥æœŸ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- æ•°æ®ç®¡ç† -->
    <div class="card">
      <h2>ğŸ“ æ•°æ®ç®¡ç†</h2>
      <div class="form-grid">
        <button onclick="exportData('json')" class="success">ğŸ’¾ å¯¼å‡ºJSON</button>
        <button onclick="exportData('csv')" class="success">ğŸ“Š å¯¼å‡ºExcel</button>
        <input type="file" id="importFile" accept=".json" style="display: none;">
        <button onclick="document.getElementById('importFile').click()">ğŸ“‚ å¯¼å…¥æ•°æ®</button>
        <button onclick="confirmReset()" class="danger">âš ï¸ é‡ç½®ç³»ç»Ÿ</button>
      </div>
    </div>
  </div>

<script>
const store = {
  init() {
    this.items = JSON.parse(localStorage.getItem('items')) || [];
    this.inbound = JSON.parse(localStorage.getItem('inbound')) || [];
    this.outbound = JSON.parse(localStorage.getItem('outbound')) || [];
    this.counters = JSON.parse(localStorage.getItem('counters')) || { 
      item: Math.max(...this.items.map(i => i.id), 0) + 1 || 1,
      in: Math.max(...this.inbound.map(i => i.id), 0) + 1 || 1,
      out: Math.max(...this.outbound.map(o => o.id), 0) + 1 || 1
    };
  },

  save() {
    localStorage.setItem('items', JSON.stringify(this.items));
    localStorage.setItem('inbound', JSON.stringify(this.inbound));
    localStorage.setItem('outbound', JSON.stringify(this.outbound));
    localStorage.setItem('counters', JSON.stringify(this.counters));
  }
};

const app = {
  init() {
    store.init();
    this.bindEvents();
    this.renderAll();
  },

  bindEvents() {
    document.getElementById('importFile').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(e.target.result);
          if (data.items && data.inbound && data.outbound) {
            Object.assign(store, data);
            store.save();
            this.renderAll();
            alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
          }
        } catch {
          alert('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼');
        }
      };
      reader.readAsText(file);
    });

    if ('ontouchstart' in window) {
      document.querySelectorAll('input, select').forEach(el => {
        el.addEventListener('focus', () => {
          window.scrollTo({ top: el.offsetTop - 100, behavior: 'smooth' });
        });
      });
    }
  },

  addItem() {
    const item = {
      id: store.counters.item++,
      name: document.getElementById('itemName').value.trim(),
      category: document.getElementById('itemCategory').value.trim(),
      spec: document.getElementById('itemSpec').value.trim(),
      unit: document.getElementById('itemUnit').value.trim(),
      quantity: parseFloat(document.getElementById('itemQuantity').value) || 0,
      min: parseFloat(document.getElementById('itemMin').value) || 0
    };

    if (!item.name) return alert('è¯·è¾“å…¥ç‰©å“åç§°');
    store.items.push(item);
    store.save();
    this.clearForm('item');
    this.renderAll();
  },

  addInbound() {
    const record = {
      id: store.counters.in++,
      itemId: parseInt(document.getElementById('inboundItem').value),
      quantity: parseFloat(document.getElementById('inboundQty').value),
      source: document.getElementById('inboundSource').value.trim(),
      date: document.getElementById('inboundDate').value || new Date().toISOString().slice(0,10),
      operator: document.getElementById('inboundOperator').value.trim()
    };

    if (!record.itemId || !record.quantity) return alert('è¯·å¡«å†™å¿…è¦ä¿¡æ¯');
    
    const item = store.items.find(i => i.id === record.itemId);
    item.quantity += record.quantity;
    store.inbound.push(record);
    store.save();
    this.clearForm('inbound');
    this.renderAll();
  },

  addOutbound() {
    const record = {
      id: store.counters.out++,
      itemId: parseInt(document.getElementById('outboundItem').value),
      quantity: parseFloat(document.getElementById('outboundQty').value),
      purpose: document.getElementById('outboundPurpose').value.trim(),
      receiver: document.getElementById('outboundReceiver').value.trim(),
      date: document.getElementById('outboundDate').value || new Date().toISOString().slice(0,10)
    };

    if (!record.itemId || !record.quantity) return alert('è¯·å¡«å†™å¿…è¦ä¿¡æ¯');
    
    const item = store.items.find(i => i.id === record.itemId);
    if (item.quantity < record.quantity) return alert('åº“å­˜ä¸è¶³ï¼');
    
    item.quantity -= record.quantity;
    store.outbound.push(record);
    store.save();
    this.clearForm('outbound');
    this.renderAll();
  },

  deleteItem(id) {
    if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿç›¸å…³å‡ºå…¥åº“è®°å½•ä¹Ÿå°†è¢«æ¸…é™¤ï¼')) return;
    
    store.items = store.items.filter(i => i.id !== id);
    store.inbound = store.inbound.filter(r => r.itemId !== id);
    store.outbound = store.outbound.filter(r => r.itemId !== id);
    store.save();
    this.renderAll();
  },

  renderAll() {
    this.renderItems();
    this.renderInbound();
    this.renderOutbound();
    this.renderSelectOptions();
  },

  renderItems() {
    const tbody = document.querySelector('#itemsTable tbody');
    tbody.innerHTML = store.items.map(item => `
      <tr>
        <td>${item.id}</td>
        <td>${item.name}</td>
        <td>${item.category}</td>
        <td>${item.spec}</td>
        <td>${item.unit}</td>
        <td>${item.quantity.toFixed(2)}</td>
        <td>${item.min}</td>
        <td>
          <button onclick="app.deleteItem(${item.id})" class="danger">åˆ é™¤</button>
        </td>
      </tr>
    `).join('');
  },

  renderInbound() {
    const tbody = document.querySelector('#inboundTable tbody');
    tbody.innerHTML = store.inbound.map(record => {
      const item = store.items.find(i => i.id === record.itemId) || {};
      return `
        <tr>
          <td>${record.id}</td>
          <td>${item.name || 'å·²åˆ é™¤'}</td>
          <td>${record.quantity.toFixed(2)}</td>
          <td>${record.source}</td>
          <td>${record.date}</td>
          <td>${record.operator}</td>
        </tr>
      `;
    }).join('');
  },

  renderOutbound() {
    const tbody = document.querySelector('#outboundTable tbody');
    tbody.innerHTML = store.outbound.map(record => {
      const item = store.items.find(i => i.id === record.itemId) || {};
      return `
        <tr>
          <td>${record.id}</td>
          <td>${item.name || 'å·²åˆ é™¤'}</td>
          <td>${record.quantity.toFixed(2)}</td>
          <td>${record.purpose}</td>
          <td>${record.receiver}</td>
          <td>${record.date}</td>
        </tr>
      `;
    }).join('');
  },

  renderSelectOptions() {
    const renderOptions = (selectId) => {
      const select = document.getElementById(selectId);
      select.innerHTML = store.items.map(item => `
        <option value="${item.id}">${item.name} (å½“å‰åº“å­˜: ${item.quantity})</option>
      `).join('');
    };
    renderOptions('inboundItem');
    renderOptions('outboundItem');
  },

  clearForm(type) {
    const forms = {
      item: ['itemName', 'itemCategory', 'itemSpec', 'itemUnit', 'itemQuantity', 'itemMin'],
      inbound: ['inboundQty', 'inboundSource', 'inboundOperator', 'inboundDate'],
      outbound: ['outboundQty', 'outboundPurpose', 'outboundReceiver', 'outboundDate']
    };
    forms[type].forEach(id => document.getElementById(id).value = '');
  },

  exportData(format) {
    if (format === 'json') {
      const data = {
        items: store.items,
        inbound: store.inbound,
        outbound: store.outbound,
        counters: store.counters
      };
      const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
      this.downloadFile(blob, `ä»“åº“å¤‡ä»½_${this.getDateString()}.json`);
    } else if (format === 'csv') {
      const csvContent = [
        '\ufeffç‰©å“æ•°æ®\n' + this.generateCSV('items'),
        '\nå…¥åº“è®°å½•\n' + this.generateCSV('inbound'),
        '\nå‡ºåº“è®°å½•\n' + this.generateCSV('outbound')
      ].join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
      this.downloadFile(blob, `ä»“åº“æ•°æ®_${this.getDateString()}.csv`);
    }
  },

  generateCSV(type) {
    let headers = [], rows = [];
    switch(type) {
      case 'items':
        headers = ['ID', 'åç§°', 'åˆ†ç±»', 'è§„æ ¼', 'å•ä½', 'å½“å‰åº“å­˜', 'æœ€ä½åº“å­˜'];
        rows = store.items.map(item => [
          item.id,
          this.escapeCSV(item.name),
          this.escapeCSV(item.category),
          this.escapeCSV(item.spec),
          this.escapeCSV(item.unit),
          item.quantity,
          item.min
        ]);
        break;
      case 'inbound':
        headers = ['ID', 'ç‰©å“ID', 'ç‰©å“åç§°', 'æ•°é‡', 'æ¥æº', 'æ—¥æœŸ', 'ç»æ‰‹äºº'];
        rows = store.inbound.map(record => {
          const item = store.items.find(i => i.id === record.itemId) || {};
          return [
            record.id,
            record.itemId,
            this.escapeCSV(item.name),
            record.quantity,
            this.escapeCSV(record.source),
            record.date,
            this.escapeCSV(record.operator)
          ];
        });
        break;
      case 'outbound':
        headers = ['ID', 'ç‰©å“ID', 'ç‰©å“åç§°', 'æ•°é‡', 'ç”¨é€”', 'é¢†ç”¨äºº', 'æ—¥æœŸ'];
        rows = store.outbound.map(record => {
          const item = store.items.find(i => i.id === record.itemId) || {};
          return [
            record.id,
            record.itemId,
            this.escapeCSV(item.name),
            record.quantity,
            this.escapeCSV(record.purpose),
            this.escapeCSV(record.receiver),
            record.date
          ];
        });
        break;
    }
    return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
  },

  escapeCSV(str) {
    return typeof str === 'string' ? `"${str.replace(/"/g, '""')}"` : '';
  },

  downloadFile(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  },

  getDateString() {
    return new Date().toISOString().slice(0, 10).replace(/-/g, '');
  },

  confirmReset() {
    if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
      localStorage.clear();
      location.reload();
    }
  }
};

app.init();

window.addItem = () => app.addItem();
window.addInbound = () => app.addInbound();
window.addOutbound = () => app.addOutbound();
window.exportData = (format) => app.exportData(format);
window.confirmReset = () => app.confirmReset();
</script>
</body>
</html>
